# 智谱AI饮食记录助手

基于智谱AI API的智能饮食记录助手，采用模块化架构设计，支持自然对话、饮食记录、消费统计和可视化分析。

## ✨ 功能特点

### 🎯 智能意图识别
- 混合检测算法：关键词匹配 + LLM验证
- 快速响应：大部分意图识别<100ms
- 高准确率：智能区分闲聊和数据记录需求

### 📝 饮食记录管理
- 自动记录饮食信息（日期、食物、金额）
- 智能信息补全提示
- 历史记录查询和统计

### 🍽️ 智能食物推荐
- 基于饮食历史的个性化推荐
- 时间段感知（早餐/午餐/晚餐/加餐）
- 避免重复推荐，提供多样化选择
- 空数据库场景的通用推荐

### 📊 数据分析可视化
- 消费统计分析
- 饮食习惯分析
- 自动生成图表和报告

### 🛠️ 文件操作支持
- 读取和写入文件
- 目录列表功能
- 多编码支持

### 🏗️ 模块化架构
- 清晰的代码结构
- 易于扩展和维护
- 高性能和内存管理

## 🏗️ 架构设计

```
app/
├── core/           # 核心配置和模型
│   ├── config.py  # 配置管理
│   └── models.py  # 自定义模型适配器
├── agents/         # Agent实现
│   ├── base_agent.py      # Agent基类
│   ├── smart_agent.py     # 智能统一Agent
│   ├── chat_agent.py      # 闲聊Agent
│   └── record_agent.py    # 记录Agent
├── tools/          # 工具函数
│   ├── tool_registry.py   # 工具注册机制
│   ├── food_tools.py      # 食物相关工具
│   ├── file_tools.py      # 文件操作工具
│   └── stats_tools.py     # 统计工具
└── utils/          # 工具类
    ├── intent_detector.py # 意图检测
    └── session_manager.py # 会话管理
```

## 🚀 快速开始

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 配置环境变量
复制环境变量模板：
```bash
cp .env.template .env
```

编辑 `.env` 文件，填入你的API密钥：
```bash
ZHIPUAI_API_KEY=your_api_key_here
MODEL_NAME=glm-4.5-flash
MAX_SESSIONS=100
SESSION_TIMEOUT=3600
```

### 3. 运行应用
```bash
# 使用启动脚本（推荐）
python run.py

# 或者直接运行
python main.py
```

### 4. 开始对话
```
🚀 正在初始化智谱AI饮食记录助手...
📁 模块化架构版本

==================================================
🎉 欢迎使用智谱AI饮食记录助手！
💡 功能特点：
   • 智能意图识别
   • 饮食记录管理
   • 智能食物推荐
   • 消费统计分析
   • 文件操作支持
   • 可视化图表生成
==================================================
📝 输入'退出'或'exit'结束对话
📊 当前活跃会话数: 1
--------------------------------------------------
你: 今天我吃了牛肉面，花了35元
🎯 识别意图: record
📝 使用记录Agent处理...
助手: 已记录：今天吃了牛肉面，花费35元
--------------------------------------------------
你: 不知道吃什么
🤖 使用智能Agent处理...
助手: 根据您最近的饮食记录，为您推荐午餐食物。考虑到您最近常吃炸鸡、牛肉面，为您推荐一些不同的选择：

🍽️ 推荐食物：
   1. 宫保鸡丁
   2. 麻婆豆腐
   3. 西红柿鸡蛋面
   4. 鱼香肉丝
   5. 冬瓜排骨汤

💡 推荐理由：根据您最近的饮食记录，为您推荐午餐食物。考虑到您最近常吃炸鸡、牛肉面，为您推荐一些不同的选择。
--------------------------------------------------
```

## 💡 使用示例

### 饮食记录
```
你: 昨天午饭我吃了炸鸡，花了45元
你: 2024年1月15日早餐喝了咖啡，花了20元
```

### 数据查询
```
你: 查看我的所有记录
你: 统计我的总消费
你: 生成消费统计图表
```

### 食物推荐
```
你: 不知道吃什么
你: 今天吃啥好
你: 有什么推荐吗
你: 给我点建议
```

### 文件操作
```
你: 读取config.txt文件
你: 列出当前目录的文件
```

### 闲聊对话
```
你: 今天天气怎么样？
你: 给我讲个笑话
```

## 🔧 高级配置

### 环境变量
| 变量名 | 描述 | 默认值 |
|--------|------|--------|
| `ZHIPUAI_API_KEY` | 智谱AI API密钥 | 必需 |
| `MODEL_NAME` | 模型名称 | `glm-4.5-flash` |
| `MAX_TOKENS` | 最大令牌数 | `1000` |
| `TEMPERATURE` | 温度参数 | `0.1` |
| `MAX_SESSIONS` | 最大会话数 | `100` |
| `SESSION_TIMEOUT` | 会话超时时间（秒） | `3600` |
| `DATABASE_PATH` | 数据库路径 | `agent_records.db` |

### 数据库结构
系统使用SQLite数据库存储：

**饮食记录表 (`eating_records`)**
- `id`: 主键
- `date`: 日期
- `food`: 食物
- `money`: 金额
- `created_at`: 创建时间

**函数调用日志表 (`function_calls`)**
- `id`: 主键
- `function_name`: 函数名称
- `arguments`: 函数参数（JSON）
- `called_at`: 调用时间

### 核心功能说明

#### 智能食物推荐
- **个性化推荐**：基于用户最近7-10天的饮食历史进行分析
- **时间段感知**：根据当前时间（早餐/午餐/晚餐/加餐）推荐合适食物
- **避免重复**：智能识别用户常吃食物，推荐多样化选择
- **空数据处理**：新用户或无历史记录时提供通用推荐

#### 推荐算法
1. 分析最近饮食记录频率
2. 识别用户饮食偏好模式
3. 根据时间段匹配推荐库
4. 过滤掉常吃食物避免重复
5. 提供个性化推荐理由

## 🛠️ 开发说明

### 添加新工具
1. 在相应的工具模块中定义新函数
2. 使用 `@tool` 装饰器
3. 在 `main.py` 中注册工具

### 扩展Agent
1. 继承 `BaseAgent` 类
2. 实现必要的方法
3. 在主应用中集成

### 自定义配置
1. 修改 `app/core/config.py`
2. 添加新的配置项
3. 更新环境变量模板

### 测试
项目包含完整的测试套件：

```bash
# 运行全面测试
python test_recommendation.py

# 运行功能演示
python demo_recommendation.py
```

测试覆盖：
- 数据库功能测试
- 推荐工具测试
- 边界情况处理
- 数据一致性验证

## 📈 性能优化

### 意图检测优化
- 关键词匹配：快速识别常见意图
- LLM验证：处理复杂情况
- 缓存机制：避免重复调用

### 内存管理
- 自动清理过期会话
- 会话数量限制
- 资源使用监控

### 数据库优化
- 参数化查询防止SQL注入
- 连接池管理
- 索引优化

## 🤝 贡献指南

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 发起 Pull Request

## 📄 许可证

本项目采用 MIT 许可证。

## 📝 更新日志

### v1.1.0 - 2025-07-31
#### 🆕 新增功能
- **智能食物推荐**：基于用户饮食历史的个性化推荐系统
- **时间段感知**：根据早餐/午餐/晚餐/加餐推荐合适食物
- **避免重复推荐**：智能识别用户常吃食物，提供多样化选择
- **推荐算法优化**：分析饮食频率和偏好模式

#### 🛠️ 技术改进
- 新增 `get_recent_eating_records()` 数据库方法
- 新增 `get_food_frequency_analysis()` 数据库方法
- 新增 `recommend_food()` 推荐工具
- 更新智能Agent系统提示，支持推荐意图识别
- 完善测试套件，100%测试覆盖率

#### 📊 测试和验证
- 创建全面的测试脚本 (`test_recommendation.py`)
- 创建功能演示脚本 (`demo_recommendation.py`)
- 修复数据库排序一致性问题
- 验证边界情况和错误处理

## 🆘 支持

如有问题，请创建 Issue 或联系开发者。 